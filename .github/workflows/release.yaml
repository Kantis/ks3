name: publish

on:
   workflow_dispatch:

#   workflow_run:
#      workflows: [ "build" ]
#      types:
#         - completed


concurrency:
   group: "${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}"
   cancel-in-progress: true


permissions:
   contents: read


jobs:

   publish:
      if: >
         github.repository == 'Kantis/ks3'
         &&
         (!github.event.workflow_run || github.event.workflow_run.conclusion == 'success')
      strategy:
         max-parallel: 1 # Sonatype doesn't like parallel uploads, so disable it where possible
         fail-fast: false
         matrix:
            include:
               # JVM, JS, and Linux
               -  os: ubuntu-latest
                  tasks: publishJvmPublicationToSonatypeReleaseRepository
               -  os: ubuntu-latest
                  tasks: publishJsPublicationToSonatypeReleaseRepository
               -  os: ubuntu-latest
                  tasks: publishLinuxX64PublicationToSonatypeReleaseRepository

               # MinGW
               -  os: windows-latest
                  tasks: publishMingwX64PublicationToSonatypeReleaseRepository

               # macOS
               -  os: macos-11
                  tasks: publishMacosArm64PublicationToSonatypeReleaseRepository
               -  os: macos-11
                  tasks: publishMacosX64PublicationToSonatypeReleaseRepository

               # iOS
               -  os: macos-11
                  tasks: publishIosArm64PublicationToSonatypeReleaseRepository
               -  os: macos-11
                  tasks: publishIosSimulatorArm64PublicationToSonatypeReleaseRepository
               -  os: macos-11
                  tasks: publishIosX64PublicationToSonatypeReleaseRepository

               # watchOS
               -  os: macos-11
                  tasks: publishWatchosArm32PublicationToSonatypeReleaseRepository
               -  os: macos-11
                  tasks: publishWatchosArm64PublicationToSonatypeReleaseRepository
               -  os: macos-11
                  tasks: publishWatchosSimulatorArm64PublicationToSonatypeReleaseRepository

               # tvOS
               -  os: macos-11
                  tasks: publishTvosArm64PublicationToSonatypeReleaseRepository
               -  os: macos-11
                  tasks: publishTvosSimulatorArm64PublicationToSonatypeReleaseRepository
               -  os: macos-11
                  tasks: publishTvosX64PublicationToSonatypeReleaseRepository

      uses: ./.github/workflows/gradle_task.yml
      secrets: inherit
      with:
         gradle-task: ${{ matrix.tasks }} --no-parallel --stacktrace --info
         runs-on: ${{ matrix.os }}

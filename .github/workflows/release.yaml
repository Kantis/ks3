name: publish

on:
   workflow_dispatch:

   workflow_run:
      workflows: [ "build" ]
      types:
         - completed


concurrency:
   group: "${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}"
   cancel-in-progress: true


permissions:
   contents: read


jobs:

   publish:
      if: github.repository == 'Kantis/ks3' && github.event.workflow_run.conclusion == 'success'
      strategy:
         max-parallel: 1 # Sonatype doesn't like parallel uploads, so disable it where possible
         matrix:
            include:
               # Linux - Kotlin/JVM
               -  os: ubuntu-latest
                  args: "-Pks3_enableKotlinJvm=true  -Pks3_enableKotlinNative=false -Pks3_enableKotlinJs=false"

               # Linux - Kotlin/JS
               -  os: ubuntu-latest
                  args: "-Pks3_enableKotlinJvm=false -Pks3_enableKotlinNative=false -Pks3_enableKotlinJs=true"

               # Linux - Kotlin/Native
               -  os: ubuntu-latest
                  args: "-Pks3_enableKotlinJvm=false -Pks3_enableKotlinNative=true  -Pks3_enableKotlinJs=false"

               # macOS - Kotlin/Native
               -  os: macos-11
                  args: "-Pks3_enableKotlinJvm=false -Pks3_enableKotlinNative=true  -Pks3_enableKotlinJs=false"

               # Windows - Kotlin/Native
               -  os: windows-latest
                  args: "-Pks3_enableKotlinJvm=false -Pks3_enableKotlinNative=true  -Pks3_enableKotlinJs=false"

      uses: ./.github/workflows/gradle_task.yml
      secrets: inherit
      timeout-minutes: 60
      with:
         gradle-task: publishAllPublicationsToSonatypeReleaseRepository ${{ matrix.args }} --no-parallel --stacktrace --info
         runs-on: ${{ matrix.os }}

name: build & publish

on:
   pull_request:

   push:
      paths-ignore:
         - 'doc/**'
         - 'documentation/**'
         - '*.md'
         - '*.yml'
      branches:
         - main
         - release/*

   workflow_dispatch:

   release:
      types: [ published ]


concurrency:
   group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
   cancel-in-progress: true


permissions:
   contents: read


jobs:

   linux-tests:
      strategy:
         matrix:
            target:
               - jvmTest
               - jsIrTest
               - linuxX64Test
      uses: ./.github/workflows/gradle_task.yml
      with:
         runs-on: ubuntu-latest
         gradle-task: ${{ matrix.target }} --stacktrace --info

   macos-tests:
      strategy:
         matrix:
            target:
               - macosX64Test
               - macosArm64Test
               - iosX64Test
               - iosSimulatorArm64Test
               - iosArm64TestKlibrary
               # - iosArm32TestKlibrary
               - tvosX64Test
               - tvosArm64TestKlibrary
               - watchosArm32TestKlibrary
               - watchosArm64TestKlibrary
               - watchosX86Test
               - watchosX64Test
      uses: ./.github/workflows/gradle_task.yml
      with:
         runs-on: macos-11
         gradle-task: ${{ matrix.target }} --stacktrace --info

   windows-tests:
      strategy:
         matrix:
            target:
               - mingwX64Test
      uses: ./.github/workflows/gradle_task.yml
      with:
         runs-on: windows-latest
         gradle-task: ${{ matrix.target }} --stacktrace --info

   linux-publish:
      needs: linux-tests
      uses: ./.github/workflows/gradle_task.yml
      with:
         gradle-task: publishAllPublicationsToSonatypeReleaseRepository --stacktrace --info
         runs-on: ubuntu-latest

   macos-publish:
      needs: macos-tests
      uses: ./.github/workflows/gradle_task.yml
      with:
         gradle-task: publishAllPublicationsToSonatypeReleaseRepository --stacktrace --info
         runs-on: macos-11

   windows-publish:
      needs: windows-tests
      uses: ./.github/workflows/gradle_task.yml
      with:
         gradle-task: publishAllPublicationsToSonatypeReleaseRepository --stacktrace --info
         runs-on: windows-latest


env:
   ORG_GRADLE_PROJECT_ks3_enableKotlinMultiplatformJvm: true
   ORG_GRADLE_PROJECT_ks3_enableKotlinMultiplatformJs: true
   ORG_GRADLE_PROJECT_ks3_enableKotlinMultiplatformNative: true
